# 2021-07-05问题排查

## 问题描述

    客服反馈推送外卖订单已经完成之后，仍然后推送发给客户。

## 问题技术 context

    客户下外卖订单后，随着订单的配送进度向前推进，一些进度信息会通过 APP 推送的方式发送给客户， 
    例如 商家已接单 -> 商家已出餐 -> 骑手已接单 -> 骑手已取货 ...  
    一直到完成订单。
    系统发送推送通知使用了 kafka 消息队列


## 问题排查过程

    通过查询日志，发现 发送消息的代码在订单状态流转过程中，已经把消息生产到 kafka ，但是 kafka 消费者消费消息延迟了 30分钟左右。
    查询日志还发现 推送服务每半个小时只能发送 5500 条推送消息，
    又定位到所有的消息都是同一个消费者消费的，所以基本上 一个消费者节点的 并发量在 5500/半小时这样。
    问题是：实际 kafka 集群是3个节点，那么一般情况下3个消费应该都能平均分配到消息
    通过 kafka 管理控制台查询到 对应的 topic 只有一个分区，所以也只有一个 消费者可以消费到消息。

## 问题解决

    通过命令 修改 topic 对应的分区数，与消费者数量保持一致
    修改后观察到 3个消费者都能正常消费消息，修复成功。